{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/producto.css') }}" />
{% endblock %}

{% block content %}
<main class="pagina">
  <section class="producto-detalle">
    <!-- Product Header -->
    <header class="producto-header">
      <h2 class="producto-nombre">{{ producto.nombre }}</h2>
    </header>

    <!-- Product Gallery -->
    <div class="producto-galeria">
      <div class="imagen-principal" role="img" aria-label="{{ producto.nombre }}">
        <img id="img-principal" src="{{ url_for('static', filename=producto.imagen) }}" alt="{{ producto.nombre }}" />
      </div>

      {% if imagenes %}
      <aside class="galeria-miniaturas" aria-label="Miniaturas del producto">
        <!-- Main image as first thumbnail -->
        <img class="miniatura seleccionada" src="{{ url_for('static', filename=producto.imagen) }}" alt="Imagen principal" />
        {% for img in imagenes %}
        <img class="miniatura" src="{{ url_for('static', filename=img.imagen) }}" alt="Miniatura {{ loop.index }}" />
        {% endfor %}
      </aside>
      {% endif %}
    </div>

    <!-- Price and Button -->
    <div class="precio-boton">
      <p class="producto-precio" aria-label="Precio del producto">$ {{ "{:.2f}".format(producto.precio) }}</p>
      <form method="POST" action="{{ url_for('main.agregar_al_carrito', producto_id=producto.id) }}">
        <button class="boton agregar-carrito" id="btn-agregar" type="submit">Agregar al carrito</button>
      </form>
    </div>

    <!-- Product Description -->
    <article class="producto-descripcion">
      {{ producto.descripcion | safe }}
    </article>
  </section>
</main>

<script>
  // Change main image on thumbnail click
  const miniaturas = document.querySelectorAll(".miniatura");
  const imgPrincipal = document.getElementById("img-principal");

  miniaturas.forEach((miniatura) => {
    miniatura.addEventListener("click", () => {
      imgPrincipal.src = miniatura.src;
      miniaturas.forEach((m) => m.classList.remove("seleccionada"));
      miniatura.classList.add("seleccionada");
    });
  });

  // Handle add to cart button
  const btnAgregar = document.getElementById("btn-agregar");
  if (btnAgregar) {
    btnAgregar.addEventListener("click", (e) => {
      e.preventDefault();
      
      // Deshabilitar el botón
      btnAgregar.disabled = true;
      btnAgregar.textContent = "¡Agregado!";
      btnAgregar.classList.add("deshabilitado");

      // Actualizar indicador del carrito
      actualizarIndicadorCarrito();
      
      // Enviar el formulario después de mostrar los cambios
      const form = btnAgregar.closest("form");
      if (form) {
        setTimeout(() => {
          form.submit();
        }, 300);
      }
    });
  }

  // Función para actualizar el indicador del carrito
  function actualizarIndicadorCarrito() {
    const carritoIconoLink = document.querySelector("a[href*='carrito']");
    let indicador = carritoIconoLink.querySelector(".carrito-indicador");

    if (!indicador) {
      indicador = document.createElement("span");
      indicador.className = "carrito-indicador";
      indicador.textContent = "1";
      carritoIconoLink.appendChild(indicador);
    } else {
      const cantidad = parseInt(indicador.textContent) + 1;
      indicador.textContent = cantidad;
    }
  }
</script>
{% endblock %}