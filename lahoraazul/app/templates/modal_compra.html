{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/modal.css') }}"
/>
<script src="https://live.decidir.com/static/v2.6.4/decidir.js"></script>
<script src="{{ url_for('static', filename='js/token.js') }}"></script>

{% endblock %}

<div
  class="modal fade"
  id="modalCompra"
  tabindex="-1"
  aria-labelledby="modalCompraLabel"
  aria-hidden="true"
  role="dialog"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form
        id="form-datos-usuario"
        method="POST"
        action="{{ url_for('main.confirmar_pedido') }}"
        novalidate
      >
        <div class="modal-header">
          <h5 class="modal-title" id="modalCompraLabel">Proceso de compra</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Cerrar"
          ></button>
        </div>

        <div class="modal-body">
          <!-- Div para errores de API -->
          <div id="api-error" class="alert alert-danger d-none" role="alert">
            <!-- Mensajes de error se insertarán aquí desde JS -->
          </div>

          <!-- Paso 1: Datos de envío -->
          <fieldset class="paso" id="paso-1">
            <!-- Nombre y Apellido -->
            <div class="row">
              <div class="col mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  name="nombre"
                  autocomplete="given-name"
                  tabindex="1"
                  required
                />
                <span
                  id="error-nombre"
                  class="error-message"
                  style="color: red; display: none"
                ></span>
              </div>
              <div class="col mb-3">
                <label for="apellido" class="form-label">Apellido</label>
                <input
                  type="text"
                  class="form-control"
                  id="apellido"
                  name="apellido"
                  autocomplete="family-name"
                  tabindex="2"
                  required
                />
                <span
                  id="error-apellido"
                  class="error-message"
                  style="color: red; display: none"
                ></span>
              </div>
            </div>

            <!-- Dirección -->
            <div class="mb-3">
              <label for="direccion" class="form-label">Dirección</label>
              <input
                type="text"
                class="form-control"
                id="direccion"
                name="direccion"
                autocomplete="shipping address-line1"
                tabindex="3"
                placeholder="Calle y número"
              />
              <span
                id="error-direccion"
                class="error-message"
                style="color: red; display: none"
              ></span>
            </div>
            <div class="mb-3">
              <label for="referencias" class="form-label"
                >Piso / Departamento / Referencias</label
              >
              <input
                type="text"
                class="form-control"
                id="referencias"
                autocomplete="shipping address-line2"
                tabindex="4"
              />
              <span
                id="error-referencias"
                class="error-message"
                style="color: red; display: none"
              ></span>
            </div>

            <!-- Localidad -->
            <fieldset class="row">
              <div class="col mb-3">
                <!-- Provincia ahora es un select con códigos de la guía -->
                <label for="provincia" class="form-label">Provincia</label>
                <select
                  class="form-control"
                  id="provincia"
                  name="provincia"
                  autocomplete="shipping address-level1"
                  tabindex="5"
                  required
                >
                  <option value="">Seleccione una provincia</option>
                  <option value="A">Salta</option>
                  <option value="B">Provincia de Buenos Aires</option>
                  <option value="C">Ciudad Autónoma de Buenos Aires</option>
                  <option value="D">San Luis</option>
                  <option value="E">Entre Ríos</option>
                  <option value="F">La Rioja</option>
                  <option value="G">Santiago del Estero</option>
                  <option value="H">Chaco</option>
                  <option value="J">San Juan</option>
                  <option value="K">Catamarca</option>
                  <option value="L">La Pampa</option>
                  <option value="M">Mendoza</option>
                  <option value="N">Misiones</option>
                  <option value="P">Formosa</option>
                  <option value="Q">Neuquén</option>
                  <option value="R">Río Negro</option>
                  <option value="S">Santa Fe</option>
                  <option value="T">Tucumán</option>
                  <option value="U">Chubut</option>
                  <option value="V">Tierra del Fuego</option>
                  <option value="W">Corrientes</option>
                  <option value="X">Córdoba</option>
                  <option value="Y">Jujuy</option>
                  <option value="Z">Santa Cruz</option>
                </select>
                <span
                  id="error-provincia"
                  class="error-message"
                  style="color: red; display: none"
                ></span>
              </div>
              <div class="col mb-3">
                <label for="localidad" class="form-label">Localidad</label>
                <input
                  type="text"
                  class="form-control"
                  id="localidad"
                  name="localidad"
                  autocomplete="shipping address-level2"
                  tabindex="6"
                  required
                />
                <span
                  id="error-localidad"
                  class="error-message"
                  style="color: red; display: none"
                ></span>
              </div>
              <div class="col mb-3">
                <label for="ciudad" class="form-label">Ciudad</label>
                <input
                  type="text"
                  class="form-control"
                  id="ciudad"
                  name="ciudad"
                  autocomplete="shipping address-level2"
                  tabindex="7"
                  required
                />
                <span
                  id="error-ciudad"
                  class="error-message"
                  style="color: red; display: none"
                ></span>
              </div>
            </fieldset>

            <!-- CP -->
            <div class="mb-3">
              <label for="cp_usuario" class="form-label">Código Postal</label>
              <input
                type="text"
                class="form-control"
                id="cp_usuario"
                name="cp_usuario"
                inputmode="numeric"
                pattern="[0-9]{4,8}"
                title="Ingrese un código postal válido (4 a 8 dígitos)"
                autocomplete="shipping postal-code"
                tabindex="8"
                required
                onchange="cotizarEnvioModal(this.value)"
              />
              <span
                id="error-cp_usuario"
                class="error-message"
                style="color: red; display: none"
              ></span>
            </div>

            <fieldset class="mb-3">
              <legend id="form-label">Seleccionar tipo de envío</legend>
              <div id="modal-tarjetas-envio">
                <!-- Retiro en local -->
                <label
                  class="tarjeta-envio-modal"
                  data-tipo="local"
                  data-precio="0"
                >
                  <input
                    type="radio"
                    name="tipo_envio"
                    value="local"
                    required
                    hidden
                  />
                  <strong>Retiro en el local</strong>
                  <span class="precio-opcion-modal">$0.00</span>
                  <small class="texto-envio">Disponible inmediatamente;</small>
                  <small class="texto-envio"
                    >retirar máximo 30 días tras la compra</small
                  >
                </label>

                <!-- Envío a domicilio -->
                <label
                  class="tarjeta-envio-modal"
                  data-tipo="domicilio"
                  data-precio="0"
                >
                  <input
                    type="radio"
                    name="tipo_envio"
                    value="domicilio"
                    hidden
                  />
                  <strong>Envío a domicilio</strong>
                  <span class="precio-opcion-modal" id="precio-domicilio-modal"
                    >Cotizando...</span
                  >
                  <small class="texto-envio" id="dias-domicilio-modal"></small>
                </label>

                <!-- Retiro en sucursal -->
                <label
                  class="tarjeta-envio-modal"
                  data-tipo="sucursal"
                  data-precio="0"
                >
                  <input
                    type="radio"
                    name="tipo_envio"
                    value="sucursal"
                    hidden
                  />
                  <strong>Retiro en sucursal</strong>
                  <span class="precio-opcion-modal" id="precio-sucursal-modal"
                    >Cotizando...</span
                  >
                  <small class="texto-envio" id="dias-sucursal-modal"></small>
                </label>
              </div>
            </fieldset>

            <div class="mb-3 d-none" id="campo-sucursal">
              <label for="selector-sucursal" class="form-label"
                >Seleccionar sucursal</label
              >
              <select
                id="selector-sucursal"
                name="selector_sucursal"
                class="form-control"
                tabindex="9"
              >
                <option value="">Seleccione una sucursal</option>
              </select>
              <small
                id="horarios-sucursal"
                class="form-text text-muted"
              ></small>
            </div>
            <div class="mb-4 p-3 bg-light rounded">
              <h6 class="mb-3">Resumen de tu compra</h6>
              <div class="d-flex justify-content-between mb-2">
                <span>Productos:</span>
                <strong id="subtotal-modal">$0.00</strong>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Envío:</span>
                <strong id="costo-envio-modal">$0.00</strong>
              </div>
              <div class="d-flex justify-content-between pt-2 border-top">
                <span><strong>Total a pagar:</strong></span>
                <strong id="total-compra-modal" class="text-primary fs-5"
                  >$0.00</strong
                >
              </div>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Correo electrónico</label>
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                autocomplete="email"
                tabindex="10"
                required
              />
              <span
                id="error-email"
                class="error-message"
                style="color: red; display: none"
              ></span>
            </div>
            <div class="mb-3">
              <label for="telefono" class="form-label">Teléfono</label>
              <input
                type="tel"
                class="form-control"
                id="telefono"
                name="telefono"
                inputmode="tel"
                pattern="[0-9+ ]{7,15}"
                autocomplete="tel"
                tabindex="11"
                required
              />
              <span
                id="error-telefono"
                class="error-message"
                style="color: red; display: none"
              ></span>
            </div>
            <!-- Mensaje extra -->
            <div class="mb-3">
              <label for="mensaje" class="form-label"
                >Mensaje extra (opcional)</label
              >
              <textarea
                class="form-control"
                id="mensaje"
                name="mensaje"
                rows="3"
                placeholder="Ej: Entregar después de las 18hs, dejar en portería..."
                tabindex="12"
              ></textarea>
            </div>
            <input type="hidden" id="total-carrito" value="2500" />
          </fieldset>

          <!-- Paso 2: Datos de pago -->
          <fieldset class="paso d-none" id="paso-2">
            <!-- Campos de tarjeta -->
            <div id="pago-tarjeta">
              <div class="mb-3">
                <label for="numero_tarjeta" class="form-label"
                  >Número de tarjeta</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="numero_tarjeta"
                  data-decidir="card_number"
                  inputmode="numeric"
                  placeholder="#### #### #### ####"
                  autocomplete="cc-number"
                  required
                />
                <small class="form-text text-muted"
                  >Ingrese los 16 dígitos de su tarjeta</small
                >
              </div>

              <div class="row">
                <div class="col">
                  <label for="vencimiento" class="form-label"
                    >Vencimiento</label
                  >
                  <div class="d-flex gap-2">
                    <input
                      type="text"
                      class="form-control"
                      id="mes_vencimiento"
                      placeholder="MM"
                      maxlength="2"
                      inputmode="numeric"
                      data-decidir="card_expiration_month"
                      autocomplete="cc-exp-month"
                      required
                    />
                    <input
                      type="text"
                      class="form-control"
                      id="anio_vencimiento"
                      placeholder="AA"
                      maxlength="2"
                      inputmode="numeric"
                      data-decidir="card_expiration_year"
                      autocomplete="cc-exp-year"
                      required
                    />
                  </div>
                </div>

                <div class="col">
                  <label for="cvv" class="form-label">CVV</label>
                  <input
                    type="text"
                    class="form-control"
                    id="cvv"
                    maxlength="4"
                    inputmode="numeric"
                    data-decidir="security_code"
                    autocomplete="cc-csc"
                    required
                  />
                </div>
              </div>

              <div class="mb-3">
                <label for="titular" class="form-label"
                  >Titular de la tarjeta</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="titular"
                  data-decidir="card_holder_name"
                  autocomplete="cc-name"
                  placeholder="Nombre como aparece en la tarjeta"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="dni" class="form-label">Documento</label>
                <div class="d-flex gap-2">
                  <select
                    id="tipo_doc"
                    data-decidir="card_holder_doc_type"
                    class="form-control"
                    style="max-width: 100px"
                    required
                  >
                    <option value="dni">DNI</option>
                    <option value="cuil">CUIL</option>
                  </select>
                  <input
                    type="text"
                    class="form-control"
                    id="dni"
                    inputmode="numeric"
                    data-decidir="card_holder_doc_number"
                    placeholder="Número de documento"
                    required
                  />
                </div>
              </div>
            </div>
          </fieldset>
          <!-- Paso 3: Confirmación -->
          <fieldset class="paso d-none" id="paso-3">
            <legend>Pedido completado</legend>
            <p>
              ¡Gracias por su compra! Su pedido ha sido procesado exitosamente.
            </p>
            <p>Le recomendamos guardar la información de su compra hasta recibir su pedido</p>
            <ul id="resumen-compra"></ul>
          </fieldset>
        </div>

        <!-- Footer con navegación -->
        <div
          class="modal-footer d-flex justify-content-end gap-2"
          id="footer-botones"
        >
          <button type="button" class="btn boton d-none" id="btn-anterior">
            Anterior
          </button>
          <button type="button" class="btn boton d-none" id="btn-siguiente">
            Siguiente
          </button>
          <button
            type="button"
            class="btn boton confirmar d-none"
            id="btn-confirmar"
          >
            Confirmar compra
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const publicKey = "{{ config.PUBLIC_KEY }}";
    initPaywayIntegration(publicKey);

    const metodoPago = document.querySelector("#metodo_pago");
    const pagoTarjeta = document.querySelector("#pago-tarjeta");

    if (metodoPago && pagoTarjeta) {
      metodoPago.addEventListener("change", function () {
        if (this.value === "tarjeta") {
          pagoTarjeta.classList.remove("d-none");
        } else {
          pagoTarjeta.classList.add("d-none");
        }
      });
    }
  });
</script>
