{% extends "base.html" %}
{% block title %}Carrito - La Hora Azul{% endblock %}
{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/carrito.css') }}"
/>
{% endblock %} {% block content %}

<main class="lista-carrito">
  {% if carrito %}
  <section class="items-carrito" aria-label="Productos en el carrito">
    {% for item in carrito %}
    <article class="item-carrito" data-producto-id="{{ item.id }}">
      <img
        src="{{ url_for('static', filename=item.imagen) }}"
        alt="Imagen de {{ item.nombre }}"
        loading="lazy"
      />
      <div class="detalle-producto">
        <div class="header-detalle">
          <h3 class="nombre-producto">{{ item.nombre }}</h3>
          <form
            method="POST"
            action="{{ url_for('main.quitar_del_carrito', producto_id=item.id) }}"
            class="form-quitar-producto"
          >
            <button
              class="btn-close"
              aria-label="Quitar {{ item.nombre }} del carrito"
              type="submit"
              data-producto-id="{{ item.id }}"
            ></button>
          </form>
        </div>
        <div class="precio-quitar">
          <p class="precio">${{ item.precio }}</p>
        </div>
      </div>
    </article>
    {% endfor %}
  </section>

  <aside class="resumen-y-confirmacion" aria-label="Resumen de compra">
    <section class="resumen-carrito">
      <div class="envio">
        <fieldset class="cotizacion-wrapper">
          <legend>Calculá el costo de tu envío</legend>
          <label for="cp_destino">Ingresá tu Código Postal:</label>
          <div class="cotizacion-horizontal">
            <input
              type="text"
              id="cp_destino"
              placeholder="Ej: 1704"
              value="8300"
              required
              inputmode="numeric"
              pattern="[0-9]{4,8}"
              title="Ingrese un código postal válido"
            />
            <button
              type="button"
              id="btn-cotizar-envio"
              aria-label="Cotizar costo de envío"
            >
              Cotizar
            </button>
          </div>
          <a
            href="https://www.correoargentino.com.ar/formularios/cpa"
            target="_blank"
            rel="noopener noreferrer"
            class="acotacion"
          >
            Buscar mi código postal
          </a>
        </fieldset>

        <fieldset class="tarjetas-envio">
          <legend>Opciones de envío</legend>

          <!-- Retiro en local -->
          <label class="tarjeta-envio" data-tipo="local" data-precio="0">
            <input type="radio" name="opcion-envio" value="local" checked />
            <strong>Retiro en el local - Sin costo</strong><br />
            <span class="precio-opcion">
              Av. Arrayanes 282 - local 8 - Villa la Angostura - Lunes a sábado
              de 11 a 21 hs.
            </span>
          </label>

          <!-- Envío a domicilio -->
          <label class="tarjeta-envio" data-tipo="domicilio" data-precio="0">
            <input type="radio" name="opcion-envio" value="domicilio" />
            <strong>Envío a domicilio</strong><br />
            <span class="precio-opcion" id="precio-domicilio"
              >Cotizando...</span
            >
            <span class="texto-envio" id="dias-domicilio"></span>
          </label>

          <!-- Retiro en sucursal -->
          <label class="tarjeta-envio" data-tipo="sucursal" data-precio="0">
            <input type="radio" name="opcion-envio" value="sucursal" />
            <strong>Retiro en sucursal</strong><br />
            <span class="precio-opcion" id="precio-sucursal"
              >Cotizando...</span
            >
            <span class="texto-envio" id="dias-sucursal"></span>
          </label>
        </fieldset>
      </div>

      <div class="costos" aria-live="polite">
        <div class="resumen-costos">
          <div class="fila">
            <span class="etiqueta">Productos:</span>
            <span class="valor" id="subtotal">${{ subtotal }}</span>
          </div>
          <div class="fila">
            <span class="etiqueta">Envío:</span>
            <span class="valor" id="costo-envio">$0.00</span>
          </div>
          <div class="fila total">
            <span class="etiqueta">Total:</span>
            <span class="valor" id="total-compra">${{ subtotal }}</span>
          </div>
        </div>
      </div>
    </section>

    <div class="finalizar-compra-container">
      <button
        class="boton"
        id="btn-finalizar"
        data-bs-toggle="modal"
        data-bs-target="#modalCompra"
      >
        Continuar
      </button>
    </div>
  </aside>

  <!-- Modal de compra separado -->
  {% include "modal_compra.html" %} 
  {% else %}
  <p class="mensaje-vacio">Tu carrito está vacío</p>
  {% endif %}

  <script>
    // ============================================
    // SINCRONIZACIÓN AL QUITAR PRODUCTOS
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
      // Interceptar formularios de quitar producto
      const formsQuitar = document.querySelectorAll('.form-quitar-producto');
      
      formsQuitar.forEach(form => {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const btnClose = this.querySelector('.btn-close');
          const productoId = btnClose.dataset.productoId;
          const itemCarrito = this.closest('.item-carrito');
          
          // Deshabilitar botón mientras procesa
          btnClose.disabled = true;
          btnClose.style.opacity = '0.5';
          
          try {
            // Enviar petición al servidor
            const response = await fetch(this.action, {
              method: 'POST',
              credentials: 'same-origin'
            });
            
            if (response.ok) {
              // Animar la eliminación del item
              itemCarrito.style.transition = 'opacity 0.3s, transform 0.3s';
              itemCarrito.style.opacity = '0';
              itemCarrito.style.transform = 'translateX(-20px)';
              
              setTimeout(() => {
                // Recargar la página para actualizar todo
                window.location.reload();
              }, 300);
            } else {
              // Si falla, restaurar el botón
              btnClose.disabled = false;
              btnClose.style.opacity = '1';
              alert('Error al quitar el producto. Intenta nuevamente.');
            }
          } catch (error) {
            console.error('Error:', error);
            btnClose.disabled = false;
            btnClose.style.opacity = '1';
            alert('Error de conexión. Intenta nuevamente.');
          }
        });
      });
      
      // Actualizar indicador del carrito en el header
      // La función actualizarIndicadorCarrito() está definida globalmente en base.html
      actualizarIndicadorCarrito();
    });
    
    // La función actualizarIndicadorCarrito() ya está definida en base.html
  </script>

  <script
    src="{{ url_for('static', filename='js/carrito.js') }}"
    defer
  ></script>
</main>
{% endblock %}