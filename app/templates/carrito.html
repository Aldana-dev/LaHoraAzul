{% extends "base.html" %} {% block title %}Carrito - La Hora Azul{% endblock %}
{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/carrito.css') }}"
/>
{% endblock %} {% block content %}
<script src="https://live.decidir.com/static/v2.5/decidir.js" defer></script>

<main class="lista-carrito">
  {% if carrito %}
  <section class="items-carrito" aria-label="Productos en el carrito">
    {% for item in carrito %}
    <article class="item-carrito">
      <img
        src="{{ url_for('static', filename=item.imagen) }}"
        alt="Imagen de {{ item.nombre }}"
        loading="lazy"
      />
      <div class="detalle-producto">
        <header class="header-detalle">
          <h3 class="nombre-producto">{{ item.nombre }}</h3>
          <form
            method="POST"
            action="{{ url_for('main.quitar_del_carrito', producto_id=item.id) }}"
          >
            <button
              class="btn-close"
              aria-label="Quitar {{ item.nombre }} del carrito"
              type="submit"
            ></button>
          </form>
        </header>
        <div class="precio-quitar">
          <p class="precio">${{ item.precio }}</p>
        </div>
      </div>
    </article>
    {% endfor %}
  </section>

  <aside class="resumen-y-confirmacion" aria-label="Resumen de compra">
    <section class="resumen-carrito">
      <div class="envio">
        <fieldset class="cotizacion-wrapper">
          <legend>Calculá el costo de tu envío</legend>
          <label for="cp_destino">Ingresá tu Código Postal:</label>
          <div class="cotizacion-horizontal">
            <input
              type="text"
              id="cp_destino"
              placeholder="Ej: 1704"
              value="8300"
              required
              inputmode="numeric"
              pattern="[0-9]{4,8}"
              title="Ingrese un código postal válido"
            />
            <button
              type="button"
              id="btn-cotizar-envio"
              aria-label="Cotizar costo de envío"
            >
              Cotizar
            </button>
          </div>
          <a
            href="https://www.correoargentino.com.ar/formularios/cpa"
            target="_blank"
            rel="noopener noreferrer"
            class="acotacion"
          >
            Buscar mi código postal
          </a>
        </fieldset>

        <fieldset class="tarjetas-envio">
          <legend>Opciones de envío</legend>

          <!-- Retiro en local -->
          <label class="tarjeta-envio" data-precio="0">
            <input type="radio" name="opcion-envio" value="local" checked />
            <strong>Retiro en el local - Sin costo</strong><br />
            <span class="precio-opcion">
              Av. Arrayanes 282 - local 8 - Villa la Angostura - Lunes a sábado
              de 11 a 21 hs.
            </span>
          </label>

          <!-- Envío a domicilio -->
          <label class="tarjeta-envio" data-tipo="domicilio" data-precio="0">
            <input type="radio" name="opcion-envio" value="domicilio" />
            <strong>Envío a domicilio</strong><br />
            <span class="precio-opcion" id="precio-domicilio">--</span>
          </label>

          <!-- Retiro en sucursal -->
          <label class="tarjeta-envio" data-tipo="sucursal" data-precio="0">
            <input type="radio" name="opcion-envio" value="sucursal" />
            <strong>Retiro en sucursal</strong><br />
            <span class="precio-opcion" id="precio-sucursal">--</span>
          </label>
        </fieldset>
      </div>

      <div class="costos" aria-live="polite">
        <div class="resumen-costos">
          <div class="fila">
            <span class="etiqueta">Productos:</span>
            <span class="valor" id="subtotal">${{ subtotal }}</span>
          </div>
          <div class="fila">
            <span class="etiqueta">Envío:</span>
            <span class="valor" id="costo-envio">$0.00</span>
          </div>
          <div class="fila total">
            <span class="etiqueta">Total:</span>
            <span class="valor" id="total-compra">${{ subtotal }}</span>
          </div>
        </div>
      </div>
    </section>

    <div class="finalizar-compra-container">
      <button
        class="btn boton"
        id="btn-finalizar"
        data-bs-toggle="modal"
        data-bs-target="#modalCompra"
      >
        Continuar
      </button>
    </div>
  </aside>

  <!-- Modal -->
  <div
    class="modal fade"
    id="modalCompra"
    tabindex="-1"
    aria-labelledby="modalCompraLabel"
    aria-hidden="true"
    role="dialog"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form
          id="form-datos-usuario"
          method="POST"
          action="{{ url_for('main.confirmar_pedido') }}"
          novalidate
        >
          <div class="modal-header">
            <h5 class="modal-title" id="modalCompraLabel">Proceso de compra</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>

          <div class="modal-body">
            <!-- Paso 1: Datos de envío -->
            <fieldset class="paso" id="paso-1">
              <!-- Nombre y Apellido -->
              <div class="row">
                <div class="col mb-3">
                  <label for="nombre" class="form-label">Nombre</label>
                  <input
                    type="text"
                    class="form-control"
                    id="nombre"
                    name="nombre"
                    autocomplete="given-name"
                    required
                  />
                </div>
                <div class="col mb-3">
                  <label for="apellido" class="form-label">Apellido</label>
                  <input
                    type="text"
                    class="form-control"
                    id="apellido"
                    name="apellido"
                    autocomplete="family-name"
                    required
                  />
                </div>
              </div>

              <!-- Dirección -->
              <div class="mb-3">
                <label for="direccion" class="form-label">Dirección</label>
                <input
                  type="text"
                  class="form-control"
                  id="direccion"
                  name="direccion"
                  autocomplete="address-line1"
                  placeholder="Calle y número"
                />
              </div>
              <div class="mb-3">
                <label for="referencias" class="form-label"
                  >Piso / Departamento / Referencias</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="referencias"
                  name="referencias"
                  autocomplete="address-line2"
                />
              </div>

              <!-- Localidad -->
              <fieldset class="row">
                <div class="col mb-3">
                  <label for="provincia" class="form-label">Provincia</label>
                  <input
                    type="text"
                    class="form-control"
                    id="provincia"
                    name="provincia"
                    autocomplete="address-level1"
                    required
                  />
                </div>
                <div class="col mb-3">
                  <label for="localidad" class="form-label">Localidad</label>
                  <input
                    type="text"
                    class="form-control"
                    id="localidad"
                    name="localidad"
                    autocomplete="address-level2"
                    required
                  />
                </div>
                <div class="col mb-3">
                  <label for="ciudad" class="form-label">Ciudad</label>
                  <input
                    type="text"
                    class="form-control"
                    id="ciudad"
                    name="ciudad"
                    required
                  />
                </div>
              </fieldset>

              <!-- CP -->
              <div class="mb-3">
                <label for="cp_usuario" class="form-label">Código Postal</label>
                <input
                  type="text"
                  class="form-control"
                  id="cp_usuario"
                  name="cp_usuario"
                  inputmode="numeric"
                  pattern="[0-9]{4,8}"
                  title="Ingrese un código postal válido (4 a 8 dígitos)"
                  autocomplete="postal-code"
                  required
                />
                <small id="ayuda-cp" class="form-text text-muted">
                  Ejemplo: 8300
                </small>
              </div>

              <fieldset class="mb-3">
                <legend id="form-label">Seleccionar tipo de envío</legend>
                <div id="modal-tarjetas-envio">
                  <!-- Retiro en local -->
                  <label
                    class="tarjeta-envio-modal"
                    data-tipo="local"
                    data-precio="0"
                  >
                    <input
                      type="radio"
                      name="tipo_envio"
                      value="local"
                      required
                      hidden
                    />
                    <strong>Retiro en el local</strong>
                    <span class="precio-opcion-modal">$0.00</span>
                    <small class="texto-envio">Disponible inmediatamente</small>
                  </label>

                  <!-- Envío a domicilio -->
                  <label class="tarjeta-envio-modal" data-tipo="domicilio">
                    <input
                      type="radio"
                      name="tipo_envio"
                      value="domicilio"
                      hidden
                    />
                    <strong>Envío a domicilio</strong>
                    <span
                      class="precio-opcion-modal"
                      id="precio-domicilio-modal"
                      >--</span
                    >
                    <small class="texto-envio" id="dias-domicilio"></small>
                  </label>

                  <!-- Retiro en sucursal -->
                  <label class="tarjeta-envio-modal" data-tipo="sucursal">
                    <input
                      type="radio"
                      name="tipo_envio"
                      value="sucursal"
                      hidden
                    />
                    <strong>Retiro en sucursal</strong>
                    <span class="precio-opcion-modal" id="precio-sucursal-modal"
                      >--</span
                    >
                    <small class="texto-envio" id="dias-sucursal"></small>
                  </label>
                </div>
              </fieldset>

              <!-- Selector de sucursal -->
              <div class="mb-3 d-none" id="campo-sucursal">
                <label for="selector-sucursal" class="form-label"
                  >Seleccionar sucursal</label
                >
                <select id="selector-sucursal" class="form-control"></select>
                <small
                  id="horarios-sucursal"
                  class="form-text text-muted"
                ></small>
              </div>

              <!-- Contacto -->
              <div class="mb-3">
                <label for="email" class="form-label">Correo electrónico</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  autocomplete="email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="telefono" class="form-label">Teléfono</label>
                <input
                  type="tel"
                  class="form-control"
                  id="telefono"
                  name="telefono"
                  inputmode="tel"
                  pattern="[0-9+ ]{7,15}"
                  autocomplete="tel"
                  required
                />
                <small class="form-text text-muted">
                  Ej: +54 294 1234567
                </small>
              </div>
            </fieldset>

            <!-- Paso 2: Datos de pago -->
            <fieldset class="paso d-none" id="paso-2">
              <div class="mb-3">
                <label for="metodo_pago" class="form-label"
                  >Método de pago</label
                >
                <select
                  id="metodo_pago"
                  name="metodo_pago"
                  class="form-control"
                  required
                >
                  <option value="">Seleccione...</option>
                  <option value="tarjeta">Tarjeta de crédito/débito</option>
                  <option value="transferencia">Transferencia bancaria</option>
                  <option value="mercadopago">MercadoPago</option>
                </select>
              </div>

              <!-- Campos de tarjeta -->
              <div id="pago-tarjeta" class="d-none">
                <div class="mb-3">
                  <label for="numero_tarjeta" class="form-label"
                    >Número de tarjeta</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="numero_tarjeta"
                    data-decidir="card_number"
                    inputmode="numeric"
                    pattern="[0-9]{13,19}"
                    placeholder="#### #### #### ####"
                  />
                </div>
                <div class="row">
                  <div class="col">
                    <label for="vencimiento" class="form-label"
                      >Vencimiento</label
                    >
                    <div class="d-flex gap-2">
                      <input
                        type="text"
                        class="form-control"
                        id="mes_vencimiento"
                        placeholder="MM"
                        maxlength="2"
                        inputmode="numeric"
                        data-decidir="card_expiration_month"
                      />
                      <input
                        type="text"
                        class="form-control"
                        id="anio_vencimiento"
                        placeholder="AA"
                        maxlength="2"
                        inputmode="numeric"
                        data-decidir="card_expiration_year"
                      />
                    </div>
                  </div>
                  <div class="col">
                    <label for="cvv" class="form-label">CVV</label>
                    <input
                      type="text"
                      class="form-control"
                      id="cvv"
                      maxlength="4"
                      pattern="[0-9]{3,4}"
                      inputmode="numeric"
                      data-decidir="security_code"
                    />
                  </div>
                </div>
                <div class="mb-3">
                  <label for="titular" class="form-label"
                    >Titular de la tarjeta</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="titular"
                    data-decidir="card_holder_name"
                    autocomplete="cc-name"
                  />
                </div>
                <div class="mb-3">
                  <label for="dni" class="form-label">Documento</label>
                  <input
                    type="text"
                    class="form-control"
                    id="dni"
                    pattern="[0-9]{7,10}"
                    inputmode="numeric"
                    data-decidir="card_holder_doc_number"
                  />
                </div>
              </div>
            </fieldset>

            <!-- Paso 3: Confirmación -->
            <fieldset class="paso d-none" id="paso-3">
              <legend>Confirmación de compra</legend>
              <p>Revisa que tus datos sean correctos antes de confirmar:</p>
              <ul id="resumen-compra"></ul>

              <!-- Términos -->
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="acepto"
                  required
                />
                <label class="form-check-label" for="acepto"
                  >Acepto los términos y condiciones</label
                >
              </div>
            </fieldset>
          </div>

          <!-- Footer con navegación -->
          <div class="modal-footer">
            <button type="button" class="btn boton" id="btn-anterior" disabled>
              Anterior
            </button>
            <button type="button" class="btn boton" id="btn-siguiente">
              Siguiente
            </button>
            <button type="submit" class="btn boton" id="btn-confirmar">
              Confirmar compra
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% else %}
  <p class="mensaje-vacio">Tu carrito está vacío</p>
  {% endif %}

  <script
    src="{{ url_for('static', filename='js/carrito.js') }}"
    defer
  ></script>
</main>
{% endblock %}
