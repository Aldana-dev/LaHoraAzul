<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Administrar Pedidos - La Hora Azul</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/estilos.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin_pedidos.css') }}"
    />
    <style>
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
    </style>
  </head>
  <body class="pagina">
    <section class="admin-panel">
      <h2 class="titulo-admin">Administrar Pedidos</h2>
      <hr class="separador" />

      <!-- FILTROS ACTUALIZADOS: nuevos e historial -->
      <div class="estado-tabla">
        <a
          href="{{ url_for('admin.admin_pedidos', filtro='nuevos') }}"
          class="btn_large boton filtro-btn {% if filtro == 'nuevos' %}activo{% endif %}"
          >Nuevos</a
        >
        <a
          href="{{ url_for('admin.admin_pedidos', filtro='historial') }}"
          class="btn_large boton filtro-btn {% if filtro == 'historial' %}activo{% endif %}"
          >Historial</a
        >
      </div>

      <!-- Formulario para marcar pedidos como historial SOLO en filtro 'nuevos' -->
      {% if filtro == 'nuevos' %}
      <form method="POST" action="{{ url_for('admin.marcar_como_historial') }}">
      {% else %}
      <form id="form-historial"> <!-- Sin action ni método para filtro historial -->
      {% endif %}

        <table class="tabla-admin">
          <thead>
  <tr>
    <th>
      <label for="select-todos" class="sr-only">Seleccionar todos</label>
      <input type="checkbox" id="select-todos" />
    </th>
    <th>ID</th>
    <th>Cliente</th>
    {% if filtro == 'nuevos' %}
    <th>Estado</th>
    {% endif %}
    <th>Fecha</th>
    <th>Precio Total</th>
    <th>Productos</th>
    <th>Datos de Envío</th> <!-- Nueva columna -->
  </tr>
</thead>
<tbody>
  {% if pedidos|length == 0 %}
  <tr>
    <td colspan="{% if filtro == 'nuevos' %}8{% else %}7{% endif %}"
        style="text-align: center; font-style: italic; color: #666">
      No hay pedidos {{ filtro }} para mostrar.
    </td>
  </tr>
  {% else %}
    {% for pedido in pedidos %}
    <tr>
      <td style="text-align: center">
        <input type="checkbox" name="pedido_ids" value="{{ pedido.id }}" />
      </td>
      <td>{{ pedido.id }}</td>
      <td>{{ pedido.nombre }} {{ pedido.apellido }}</td>
      {% if filtro == 'nuevos' %}
      <td>
        {% set dias = (current_time.date() - pedido.fecha.date()).days %}
        <span class="indicador-estado {% if dias == 0 %}verde {% elif dias >= 7 %}rojo {% else %}amarillo {% endif %}">
        </span>
      </td>
      {% endif %}
      <td>{{ pedido.fecha.strftime('%d/%m/%Y') }}</td>
      <td>${{ pedido.total }}</td>
      <td>
        {% for item in pedido.items %}
        <div class="producto-resumen">
          <img src="{{ url_for('static', filename=item.producto.imagen) }}" alt="{{ item.producto.nombre }}" />
          <div>
            <p>{{ item.producto.nombre }}</p>
            <p>${{ item.precio_unitario }}</p>
          </div>
        </div>
        {% endfor %}
      </td>
      <td>
        <p><strong>Email:</strong> {{ pedido.email_contacto }}</p>
        <p><strong>Teléfono:</strong> {{ pedido.telefono }}</p>
        <p><strong>Provincia:</strong> {{ pedido.provincia }}</p>
        <p><strong>Localidad:</strong> {{ pedido.localidad }}</p>
        <p><strong>Ciudad:</strong> {{ pedido.ciudad }}</p>
        <p><strong>Código Postal:</strong> {{ pedido.cp_usuario }}</p>
        <p><strong>Dirección:</strong> {{ pedido.direccion }}</p>
        <p><strong>Referencias:</strong> {{ pedido.referencias }}</p>
        <p><strong>Tipo de envío:</strong> {{ pedido.tipo_envio }}</p>
        <p><strong>Comentarios:</strong> {{ pedido.comentarios }}</p>
      </td>
    </tr>
    {% endfor %}
  {% endif %}
</tbody>

        </table>

        {% if filtro == 'nuevos' %}
        <div class="text-center" style="margin-top: 1rem">
          <button type="submit" class="btn_large boton">
            Pasar a Historial
          </button>
        </div>
        {% endif %}
      </form>

      <div class="text-center mt-5">
        <a href="{{ url_for('admin.admin') }}" class="btn boton">
          Volver al Panel
        </a>
      </div>
    </section>

    <script>
      // Select/Deselect all checkboxes
      document
        .getElementById("select-todos")
        .addEventListener("change", function () {
          const checked = this.checked;
          document
            .querySelectorAll('input[name="pedido_ids"]')
            .forEach((cb) => (cb.checked = checked));
        });

      function cerrarModal() {
        document.getElementById("modal-pedido").style.display = "none";
      }

      // Eliminamos todo JS relacionado a modal eliminar pedidos
    </script>
  </body>
</html>
