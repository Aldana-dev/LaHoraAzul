<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Administrar Pedidos - La Hora Azul</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/estilos.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin.css') }}"
    />
  </head>
  <body class="pagina">
    <section class="admin-panel">
      <h2 class="titulo-admin">Administrar Pedidos</h2>
      <hr class="separador" />

      <!-- Filtros de estado -->
      <div class="estado-tabla">
        <a
          href="{{ url_for('admin_pedidos', filtro='todos') }}"
          class="boton filtro-btn {% if filtro == 'todos' %}activo{% endif %}"
          >Todos</a
        >
        <a
          href="{{ url_for('admin_pedidos', filtro='pendientes') }}"
          class="boton filtro-btn {% if filtro == 'pendientes' %}activo{% endif %}"
          >Pendientes</a
        >
        <a
          href="{{ url_for('admin_pedidos', filtro='enviados') }}"
          class="boton filtro-btn {% if filtro == 'enviados' %}activo{% endif %}"
          >Enviados</a
        >
      </div>

      <!-- Formulario para actualizar estados masivamente -->
      <form
        method="POST"
        action="{{ url_for('actualizar_estado_masivo', filtro=filtro) }}"
      >
        <table class="tabla-admin">
          <thead>
            <tr>
              {% if filtro != 'todos' %}
              <th></th>
              <!-- Columna checkbox solo si no es 'todos' -->
              {% endif %}
              <th>ID</th>
              <th>Cliente</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for pedido in pedidos %}
            <tr>
              {% if filtro != 'todos' %}
              <td style="text-align: center">
                <input type="checkbox" name="enviar_ids" value="{{ pedido.id }}"
                {% if filtro == 'enviados' %}checked{% endif %} />
              </td>
              {% endif %}
              <td>{{ pedido.id }}</td>
              <td>{{ pedido.email_contacto }}</td>
              <td>{{ pedido.estado }}</td>
              <td>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
              <td>
                <button
                  class="btn boton small-btn"
                  type="button"
                  onclick="abrirModal('{{ pedido.id }}')"
                >
                  Ver
                </button>
              </td>
            </tr>

            <!-- Contenido modal oculto para cada pedido -->
            <tr
              id="modal-{{ pedido.id }}"
              class="fila-modal"
              style="display: none"
            >
              <td colspan="6">
                <div class="productos-modal-container">
                  {% for item in pedido.items %}
                  <div class="producto-modal">
                    <img
                      src="{{ url_for('static', filename=item.producto.imagen) }}"
                      alt="{{ item.producto.nombre }}"
                    />
                    <div class="detalle-producto-modal">
                      <p><strong>{{ item.producto.nombre }}</strong></p>
                      <p>Precio unitario: ${{ item.precio_unitario }}</p>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if filtro != 'todos' %}
        <div class="text-center" style="margin-top: 1rem">
          <button type="submit" class="btn boton">Actualizar estados</button>
          {% if filtro == 'enviados' %}
          <button
            type="button"
            class="btn boton"
            onclick="abrirModalBorrar()"
          >
            Borrar registros
          </button>
          {% endif %}
        </div>
        {% endif %}
      </form>

      <div class="text-center mt-5">
        <a href="{{ url_for('admin') }}" class="btn boton">Volver al Panel</a>
      </div>
    </section>

    <!-- Modal flotante -->
    <div id="modal-pedido" class="modal">
      <div class="modal-content" id="modal-contenido">
        <span class="cerrar" onclick="cerrarModal()">&times;</span>
        <!-- Contenido dinámico cargado con JS -->
      </div>
    </div>
    <!-- Modal de confirmación para borrar -->
    <div id="modal-borrar" class="modal">
      <div class="modal-content">
        <span class="cerrar" onclick="cerrarModalBorrar()">&times;</span>
        <h4>¿Estás segura de que querés borrar estos registros?</h4>
        <p>
          Se eliminarán los pedidos enviados con más de 1 mes de antigüedad que
          estén seleccionados.
        </p>
        <form
          id="form-borrar"
          method="POST"
          action="{{ url_for('borrar_pedidos_antiguos') }}"
        >
          <!-- Este input oculto se llenará con JS con los IDs seleccionados -->
          <input type="hidden" name="borrar_ids" id="borrar-ids" />
          <div class="text-center" >
            <button type="submit" class="btn boton ">
              Confirmar borrado
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function abrirModal(id) {
        const modal = document.getElementById("modal-pedido");
        const contenido = document.getElementById("modal-contenido");
        const original = document.getElementById("modal-" + id);

        if (original) {
          const productos = original
            .querySelector(".productos-modal-container")
            .cloneNode(true);
          contenido.innerHTML = `
            <span class="cerrar" onclick="cerrarModal()">&times;</span>
            <h4>Productos del pedido #${id}</h4>
          `;
          contenido.appendChild(productos);
          modal.style.display = "flex";
        }
      }

      function cerrarModal() {
        document.getElementById("modal-pedido").style.display = "none";
      }

      function abrirModalBorrar() {
        const checkboxes = document.querySelectorAll(
          'input[name="enviar_ids"]:checked'
        );
        const ids = Array.from(checkboxes).map((cb) => cb.value);
        if (ids.length === 0) {
          alert("Seleccioná al menos un pedido para borrar.");
          return;
        }
        document.getElementById("borrar-ids").value = JSON.stringify(ids);
        document.getElementById("modal-borrar").style.display = "flex";
      }

      function cerrarModalBorrar() {
        document.getElementById("modal-borrar").style.display = "none";
      }
    </script>
  </body>
</html>
